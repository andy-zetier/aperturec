name: Scheduled Image Builds

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build images from (branch, tag, or SHA)'
        required: false
        default: 'main'
        type: string

concurrency:
  group: scheduled-images-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  common-setup:
    runs-on: ubuntu-latest
    outputs:
      container-repo: ${{ steps.setup.outputs.container-repo }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          ref: ${{ inputs.ref || 'main' }}

      - id: setup
        run: |
          config=$(jq -c < ./.github/config/global.json)
          registry=$(echo "$config" | jq -r '.registry')
          repo_normalized=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
          echo "container-repo=${registry}/${repo_normalized}/build-images" >> $GITHUB_OUTPUT

  linux-images-build:
    needs: common-setup
    uses: ./.github/workflows/create-images.yml
    with:
      config-path: ./.github/config/linux-images.json
      container-repo: ${{ needs.common-setup.outputs.container-repo }}
      skip-cache-from: true
    secrets: inherit

  windows-images-build:
    needs: common-setup
    uses: ./.github/workflows/create-images.yml
    with:
      config-path: ./.github/config/windows-images.json
      container-repo: ${{ needs.common-setup.outputs.container-repo }}
      skip-cache-from: true
    secrets: inherit