name: Create Images

on:
  workflow_call:
    inputs:
      container-repo:
        description: 'Container repository with registry'
        required: true
        type: string
      config-path:
        description: 'Path to images configuration JSON'
        required: true
        type: string
      skip-cache-from:
        description: 'Skip importing cache (for scheduled builds to force fresh pulls)'
        required: false
        default: false
        type: boolean
    outputs:
      digests:
        description: 'Map of image digests keyed by "{target}-{os}-{arch}"'
        value: ${{ jobs.process-digests.outputs.result }}

env:
  REGISTRY: ghcr.io

jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      build-matrix: ${{ steps.config.outputs.build-matrix }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - id: config
        run: |
          echo "build-matrix=$(jq -c . < ${{ inputs.config-path }})" >> $GITHUB_OUTPUT
  build:
    runs-on: ${{ matrix.platform_runner.runner }}
    needs: config
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.config.outputs.build-matrix) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435
      - uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: build-vars
        run: |
          platform="${{ matrix.platform_runner.platform }}"
          arch="${platform#*/}"
          image_tag="${{ matrix.target }}-${{ matrix.os.image_name }}-${arch}"
          image="${{ inputs.container-repo }}:${image_tag}"
          echo "arch=${arch}" >> $GITHUB_OUTPUT
          echo "image-tag=${image_tag}" >> $GITHUB_OUTPUT
          echo "image=${image}" >> $GITHUB_OUTPUT
      - id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        env:
          DOCKER_BUILD_SUMMARY: false
          DOCKER_BUILD_RECORD_UPLOAD: false
        with:
          context: ./ci/images
          platforms: ${{ matrix.platform_runner.platform }}
          target: ${{ matrix.target }}
          build-args: |
            IMAGE_UPSTREAM=${{ matrix.os.image_upstream }}
            OS_VARIANT=${{ matrix.os.os_variant }}
          outputs: type=registry,name=${{ steps.build-vars.outputs.image }}
          cache-from: ${{ inputs.skip-cache-from && '' || format('type=registry,ref=%s,mode=max', steps.build-vars.outputs.image) }}
          cache-to: |
            type=registry,ref=${{ steps.build-vars.outputs.image }}
          pull: ${{ inputs.skip-cache-from }}
      - uses: cloudposse/github-action-matrix-outputs-write@ed06cf3a6bf23b8dce36d1cf0d63123885bb8375
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ steps.build-vars.outputs.image-tag }}
          outputs: |-
            digest: ${{ steps.build.outputs.digest }}
  process-digests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@33cac12fa9282a7230a418d859b93fdbc4f27b5a
        id: read
        with:
          matrix-step-name: build
    outputs:
      result: ${{ toJson(fromJson(steps.read.outputs.result).digest) }}
