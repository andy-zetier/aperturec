stages:
  - create-images
  - check-build-test
  - package
  - doc

.architectures:all:
  - amd64
  - arm64

.crates:package:
  - aperturec-client
  - aperturec-server
.crates:no-extra-dependencies: "aperturec-metrics,aperturec-protocol,aperturec-state-machine,aperturec-utils"
.crates:fips-dependencies: "aperturec-channel"
.crates:server-dependencies: "aperturec-server"
.crates:client-dependencies: "aperturec-client"

.ubuntu-22: &ubuntu-22
  IMAGE_UPSTREAM: docker.io/library/ubuntu:22.04
  IMAGE_NAME: ubuntu-22
.ubuntu-24: &ubuntu-24
  IMAGE_UPSTREAM: docker.io/library/ubuntu:24.04
  IMAGE_NAME: ubuntu-24
.fedora-40: &fedora-40
  IMAGE_UPSTREAM: docker.io/library/fedora:40
  IMAGE_NAME: fedora-40
.fedora-41: &fedora-41
  IMAGE_UPSTREAM: docker.io/library/fedora:41
  IMAGE_NAME: fedora-41
.centos-stream9: &centos-stream9
  IMAGE_UPSTREAM: quay.io/centos/centos:stream9
  IMAGE_NAME: centos-stream9

.runner-arch:independent:
  tags:
    - linux
    - docker
.runner-arch:dependent:
  tags:
    - linux
    - docker
    - $ARCHITECTURE

.targets:all:
  - rust-image
  - fips-capable-image
  - client-image
  - server-image

.create-images:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        IMAGE_VERSION: "$CI_DEFAULT_BRANCH"
    - if: $CI_COMMIT_BRANCH
      changes:
        paths:
          - ci/**/*
          - .gitlab-ci.yml
        compare_to: main
      variables:
        IMAGE_VERSION: "branch-$CI_COMMIT_BRANCH"

create-images:build:
  stage: create-images
  extends:
    - .runner-arch:dependent
    - .create-images
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    IMAGE_VERSION: "$CI_DEFAULT_BRANCH"
  script:
    - >-
      /kaniko/executor
      --snapshot-mode redo
      --single-snapshot
      --ignore-var-run
      --ignore-path /dev
      --ignore-path /proc
      --use-new-run
      --context "$CI_PROJECT_DIR/ci/images/"
      --build-arg IMAGE_UPSTREAM
      --build-arg OS_VARIANT
      --build-arg ARCHITECTURE
      --target $IMAGE_TARGET
      --skip-unused-stages
      --destination "$CI_REGISTRY_IMAGE/$IMAGE_VERSION-$IMAGE_TARGET-$ARCHITECTURE-$IMAGE_NAME"
      --registry-certificate "$CI_REGISTRY=$CI_SERVER_TLS_CA_FILE"
  parallel:
    matrix:
      - <<: *ubuntu-22
        OS_VARIANT: debian
        ARCHITECTURE: !reference [.architectures:all]
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *ubuntu-24
        OS_VARIANT: debian
        ARCHITECTURE: !reference [.architectures:all]
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *fedora-41
        OS_VARIANT: fedora
        ARCHITECTURE: !reference [.architectures:all]
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *centos-stream9
        OS_VARIANT: fedora
        ARCHITECTURE: !reference [.architectures:all]
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *fedora-40
        OS_VARIANT: fedora
        ARCHITECTURE: amd64
        IMAGE_TARGET: client-image-windows

create-images:deploy-manifest:
  stage: create-images
  image:
    name: mplatform/manifest-tool:alpine
    entrypoint: [""]
  variables:
    PLATFORMS: linux/amd64,linux/arm64
  extends:
    - .runner-arch:independent
    - .create-images
  script:
    - cat "$CI_SERVER_TLS_CA_FILE" >> /etc/ssl/certs/ca-certificates.crt
    - >-
      /manifest-tool
      --username $CI_REGISTRY_USER
      --password $CI_REGISTRY_PASSWORD
      push
      from-args
      --platforms $PLATFORMS
      --template "$CI_REGISTRY_IMAGE/$IMAGE_VERSION-$IMAGE_TARGET-ARCH-$IMAGE_NAME:latest"
      --target "$CI_REGISTRY_IMAGE/$IMAGE_VERSION-$IMAGE_TARGET-$IMAGE_NAME:latest"
  parallel:
    matrix:
      - <<: *ubuntu-22
        OS_VARIANT: debian
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *ubuntu-24
        OS_VARIANT: debian
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *fedora-41
        OS_VARIANT: fedora
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *centos-stream9
        OS_VARIANT: fedora
        IMAGE_TARGET: !reference [.targets:all]
      - <<: *fedora-40
        OS_VARIANT: fedora
        IMAGE_TARGET: client-image-windows
        PLATFORMS: linux/amd64
  needs:
    - job: create-images:build

.custom-image:
  interruptible: true
  variables:
    IMAGE_VERSION: "$CI_DEFAULT_BRANCH"
    IMAGE_NAME: ubuntu-22
    IMAGE: "$CI_REGISTRY_IMAGE/$IMAGE_VERSION-$IMAGE_TARGET-$IMAGE_NAME:latest"
  image:
    name: $IMAGE
    pull_policy: always
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        paths:
          - ci/**/*
          - .gitlab-ci.yml
        compare_to: main
      variables:
        IMAGE_VERSION: "branch-$CI_COMMIT_BRANCH"
    - if: $CI_COMMIT_BRANCH
      variables:
        IMAGE_VERSION: "$CI_DEFAULT_BRANCH"

.cargo:
  extends: .custom-image
  interruptible: true
  variables:
    IMAGE_TARGET: rust-image
  before_script:
    - export CARGO_ARGS=`sed -e 's/^/-p /g' -e 's/,/ -p /g' <<< $CRATES`

cargo:check-license:
  stage: check-build-test
  extends:
    - .runner-arch:independent
    - .cargo
  script:
    - cargo deny check licenses
  parallel:
    matrix:
      - CRATES: !reference [.crates:package]
  needs:
    - job: create-images:deploy-manifest
      optional: true

cargo:check-build-test:
  stage: check-build-test
  extends:
    - .runner-arch:dependent
    - .cargo
  script:
    - cargo fmt $CARGO_ARGS -- --check
    - cargo check --benches $CARGO_ARGS
    - cargo build $CARGO_ARGS
    - Xvfb :5 &> /dev/null &
    - export DISPLAY=:5
    - RUST_BACKTRACE=1 cargo test $CARGO_ARGS
    - cargo build $CARGO_ARGS --release
    - |-
      if [[ -f target/release/$CRATES ]]; then
        mv target/release/$CRATES target/release/$CRATES-$IMAGE_NAME-$ARCHITECTURE
      fi
    - git diff-index --quiet HEAD
  parallel:
    matrix:
      - <<: *ubuntu-22
        CRATES: !reference [.crates:no-extra-dependencies]
        IMAGE_TARGET: rust-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: !reference [.crates:no-extra-dependencies]
        IMAGE_TARGET: rust-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *fedora-41
        CRATES: !reference [.crates:no-extra-dependencies]
        IMAGE_TARGET: rust-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *centos-stream9
        CRATES: !reference [.crates:no-extra-dependencies]
        IMAGE_TARGET: rust-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-22
        CRATES: !reference [.crates:fips-dependencies]
        IMAGE_TARGET: fips-capable-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: !reference [.crates:fips-dependencies]
        IMAGE_TARGET: fips-capable-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *fedora-41
        CRATES: !reference [.crates:fips-dependencies]
        IMAGE_TARGET: fips-capable-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *centos-stream9
        CRATES: !reference [.crates:fips-dependencies]
        IMAGE_TARGET: fips-capable-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-22
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *fedora-41
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *centos-stream9
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-22
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *fedora-41
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *centos-stream9
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
  needs:
    - job: create-images:deploy-manifest
      optional: true
  artifacts:
    paths: [target/release/$CRATES-$IMAGE_NAME-$ARCHITECTURE]

cargo:check-build-windows-client:
  stage: check-build-test
  extends:
    - .runner-arch:dependent
    - .cargo
  script:
    - cargo fmt $CARGO_ARGS -- --check
    - cargo check --benches $CARGO_ARGS
    - cargo build $CARGO_ARGS
    - mkdir test_executables
    - cargo test $CARGO_ARGS -q --no-run --message-format=json | jq -r 'select(.profile.test == true) | .filenames[]' | xargs -I {} cp {} test_executables/
    - cargo build $CARGO_ARGS --release
    - mv target/x86_64-pc-windows-gnu/release/$CRATES.exe .
    - git diff-index --quiet HEAD
  variables:
    <<: *fedora-40
    CRATES: aperturec-client
    IMAGE_TARGET: client-image-windows
    ARCHITECTURE: amd64
  needs:
    - job: create-images:deploy-manifest
      optional: true
  artifacts:
    paths: [test_executables, $CRATES.exe]

cargo:doc:
  stage: doc
  extends:
    - .cargo
    - .runner-arch:independent
  script:
    - cargo doc $CARGO_ARGS
  artifacts:
    paths:
      - target/doc/
  parallel:
    matrix:
      - CRATES: !reference [.crates:no-extra-dependencies]
        IMAGE_TARGET: rust-image
      - CRATES: !reference [.crates:server-dependencies]
        IMAGE_TARGET: server-image
      - CRATES: !reference [.crates:client-dependencies]
        IMAGE_TARGET: client-image
  needs:
    - job: cargo:check-build-test

package:windows-client:
  stage: package
  extends:
    - .runner-arch:dependent
    - .custom-image
  script:
    - $CI_PROJECT_DIR/ci/scripts/create-windows-package.sh
  variables:
    <<: *fedora-40
    CRATES: aperturec-client
    IMAGE_TARGET: client-image-windows
    ARCHITECTURE: amd64
  needs:
    - job: cargo:check-build-windows-client
  artifacts:
    paths:
      - aperturec-client-win.zip
      - aperturec-client.msi

package:create-deb:
  stage: package
  extends:
    - .cargo
    - .runner-arch:dependent
  script:
    - mv target/release/$CRATES-$IMAGE_NAME-$ARCHITECTURE target/release/$CRATES
    - cargo deb $CARGO_ARGS -o ./target/$(lsb_release -i -s | tr "A-Z" "a-z")/$(lsb_release -c -s)/ --deb-revision="$CI_PIPELINE_IID" --no-build -- --release
  artifacts:
    paths: [target/*/*/$CRATES_*_*.deb]
  needs:
    - job: cargo:check-build-test
      parallel:
        matrix:
          - <<: *ubuntu-22
            CRATES: aperturec-server
            IMAGE_TARGET: server-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *ubuntu-24
            CRATES: aperturec-server
            IMAGE_TARGET: server-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *ubuntu-22
            CRATES: aperturec-client
            IMAGE_TARGET: client-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *ubuntu-24
            CRATES: aperturec-client
            IMAGE_TARGET: client-image
            ARCHIECTURE: !reference [.architectures:all]
  parallel:
    matrix:
      - <<: *ubuntu-22
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-22
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
      - <<: *ubuntu-24
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]

package:create-rpm:
  stage: package
  extends:
    - .cargo
    - .runner-arch:dependent
  script:
    - mv target/release/$CRATES-$IMAGE_NAME-$ARCHITECTURE target/release/$CRATES
    - VERSION_ID=$(grep '^VERSION_ID=' /etc/os-release | cut -d'=' -f2 | tr -d '"')
    - mkdir -p target/$PKG_CLOUD_ID/$VERSION_ID
    - cargo generate-rpm $CARGO_ARGS -o ./target/$PKG_CLOUD_ID/$VERSION_ID/ -s "{ release=$CI_PIPELINE_IID }"
  artifacts:
    paths: [target/*/*/$CRATES*.rpm]
  needs:
    - job: cargo:check-build-test
      parallel:
        matrix:
          - <<: *fedora-41
            CRATES: aperturec-server
            IMAGE_TARGET: server-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *centos-stream9
            CRATES: aperturec-server
            IMAGE_TARGET: server-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *fedora-41
            CRATES: aperturec-client
            IMAGE_TARGET: client-image
            ARCHIECTURE: !reference [.architectures:all]
          - <<: *centos-stream9
            CRATES: aperturec-client
            IMAGE_TARGET: client-image
            ARCHIECTURE: !reference [.architectures:all]
  parallel:
    matrix:
      - <<: *fedora-41
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
        PKG_CLOUD_ID: fedora
      - <<: *centos-stream9
        CRATES: aperturec-server
        IMAGE_TARGET: server-image
        ARCHITECTURE: !reference [.architectures:all]
        PKG_CLOUD_ID: el
      - <<: *fedora-41
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
        PKG_CLOUD_ID: fedora
      - <<: *centos-stream9
        CRATES: aperturec-client
        IMAGE_TARGET: client-image
        ARCHITECTURE: !reference [.architectures:all]
        PKG_CLOUD_ID: el

package:push:
  stage: package
  extends:
    - .runner-arch:independent
  image:
    name: ruby:slim-bookworm
    entrypoint: [""]
  script:
    - gem install package_cloud
    - ./ci/scripts/package_upload.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"
  needs:
    - job: package:create-deb
    - job: package:create-rpm
