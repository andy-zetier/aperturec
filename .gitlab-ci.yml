stages:
  - build-images
  - check
  - build
  - package
  - test
  - doc

variables:
  RUST_BASE_IMAGE: "$CI_REGISTRY_IMAGE/rust/base:$CI_COMMIT_REF_SLUG"
  RUST_ASN1C_IMAGE: "$CI_REGISTRY_IMAGE/rust/asn1c:$CI_COMMIT_REF_SLUG"
  RUST_XBACKEND_IMAGE: "$CI_REGISTRY_IMAGE/rust/base:$CI_COMMIT_REF_SLUG"

default:
  tags:
    - linux
    - docker
    - amd64

.image:build-push:
  stage: build-images
  image:
    name: gcr.io/kaniko-project/executor:v1.13.0-debug
    entrypoint: [""]
  script:
    - >-
      /kaniko/executor
      --snapshot-mode=redo
      --context "$CI_PROJECT_DIR/images/$IMAGE"
      --build-arg BASE_IMAGE
      --destination "$CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_REF_SLUG"
      --registry-certificate "$CI_REGISTRY=$CI_SERVER_TLS_CA_FILE"

.rules:event:push: &rules-event-push
  $CI_PIPELINE_SOURCE == "push"

.needs:image:rust:base: &needs-image-rust-base
  needs:
    - job: image:build-push:rust:base
      optional: true

.needs:image:rust:asn1c: &needs-image-rust-asn1c
  needs:
    - job: image:build-push:rust:asn1c
      optional: true

image:build-push:rust:base:
  extends: .image:build-push
  variables:
    IMAGE: rust/base
  rules:
    - if: *rules-event-push
      changes:
        - images/rust/base/*

image:build-push:rust:asn1c:
  extends: .image:build-push
  variables:
    IMAGE: rust/asn1c
    BASE_IMAGE: "$RUST_BASE_IMAGE"
  rules:
    - if: *rules-event-push
      changes:
        - images/rust/asn1c/*
    - !reference [ image:build-push:rust:base, rules ]
  <<: *needs-image-rust-base

image:build-push:rust:xbackend:
  extends: .image:build-push
  variables:
    IMAGE: rust/xbackend
    BASE_IMAGE: "$RUST_BASE_IMAGE"
  rules:
    - if: *rules-event-push
      changes:
        - images/rust/xbackend/*
    - !reference [ image:build-push:rust:base, rules ]
  <<: *needs-image-rust-base

image:build-push:rust:client:
  extends: .image:build-push
  variables:
    IMAGE: rust/client
    BASE_IMAGE: "$RUST_BASE_IMAGE"
  rules:
    - if: *rules-event-push
      changes:
        - images/rust/client/*
    - !reference [ image:build-push:rust:base, rules ]
  <<: *needs-image-rust-base

.cargo:
  image: "$CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_REF_SLUG"
  before_script:
    - rustup update
    - cd "$SUBDIR"
  variables:
    IMAGE: "rust/base"
  <<: *needs-image-rust-base
  needs:
    - job: image:build-push:rust:asn1c
      optional: true
    - job: image:build-push:rust:client
      optional: true
    - job: image:build-push:rust:xbackend
      optional: true
  parallel:
    matrix:
      - SUBDIR: "protocol"
        IMAGE: "rust/asn1c"
        FEATURES_TEST: asn1c-tests
      - SUBDIR: "state_machine"
      - SUBDIR: "state_machine/derive"
      - SUBDIR: "channel"
        IMAGE: "rust/asn1c"
      - SUBDIR: "client"
        IMAGE: "rust/client"
      - SUBDIR: "server"
        IMAGE: "rust/xbackend"
      - SUBDIR: "metrics"

.cargo:debug:
  extends: .cargo

.cargo:release:
  extends: .cargo
  variables:
    FLAGS: "--release"

cargo:format-check:
  extends: .cargo
  stage: check
  before_script:
    - !reference [.cargo, before_script]
    - rustup component add rustfmt
  script:
    - cargo fmt -- --check

.cargo:check: &cargo-check
  stage: check
  script:
    - cargo check $FLAGS --features "$FEATURES_CHECK"

cargo:check:debug:
  extends: .cargo:debug
  <<: *cargo-check

cargo:check:release:
  extends: .cargo:release
  <<: *cargo-check

.cargo:build: &cargo-build
  stage: build
  script:
    - cargo build $FLAGS --features "$FEATURES_BUILD"

cargo:build:debug:
  extends: .cargo:debug
  <<: *cargo-build

cargo:build:release:
  extends: .cargo:release
  <<: *cargo-build

.cargo:test: &cargo-test
  stage: test
  script:
    - cargo test $FLAGS --features "$FEATURES_TEST"

cargo:test:debug:
  extends: .cargo:debug
  <<: *cargo-test

cargo:test:release:
  extends: .cargo:release
  <<: *cargo-test

.cargo:doc: &cargo-doc
  stage: doc
  script:
    - cargo doc $FLAGS --features "$FEATURES_DOC"

cargo:doc:debug:
  extends: .cargo:debug
  <<: *cargo-doc

cargo:doc:release:
  extends: .cargo:release
  <<: *cargo-doc

cargo:package:deb:client:
  stage: package
  image: "$IMAGE"
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install --no-install-recommends -y ca-certificates curl build-essential pkg-config libgtk-3-dev cmake pkg-config libssl-dev lsb-release
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$HOME/.cargo/env"
    - cargo install cargo-deb
    - cd "client"
    - mkdir -p ./target/$(lsb_release -i -s | tr "A-Z" "a-z")/$(lsb_release -c -s)/
  script:
    - cargo deb -o ./target/$(lsb_release -i -s | tr "A-Z" "a-z")/$(lsb_release -c -s)/ --deb-revision="$CI_PIPELINE_IID"
  needs:
    - job: cargo:build:release
  artifacts:
    paths:
      - client/target/*/*/aperturec-client_*_amd64.deb
  parallel:
    matrix:
      - IMAGE: "ubuntu:18.04"
      - IMAGE: "ubuntu:20.04"
      - IMAGE: "ubuntu:22.04"

cargo:package:deb:push:
  stage: package
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: ubuntu:22.04
  # Because this is not utilizing built native code we don't need to require amd64
  tags:
    - linux
    - docker
  before_script:
    - apt update
    - DEBIAN_FRONTEND=noninteractive apt install --no-install-recommends -y ca-certificates rubygems
    - gem install package_cloud
  script:
    - ./scripts/package_upload.sh client
  needs:
    - job: cargo:package:deb:client
